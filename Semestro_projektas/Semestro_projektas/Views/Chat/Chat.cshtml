@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer _localizer

@model IEnumerable<Message>
@{
    IEnumerable<User> users = ViewData["User"] as IEnumerable<User>;
    IEnumerable<Channel> userChannels = ViewData["userChannels"] as IEnumerable<Channel>;
    IEnumerable<string> roles = ViewData["Roles"] as IEnumerable<string>;
    int roleVal = 0;
}


<!--EmojiOneArea -->
<!--<link href="Content/emojionearea.min.css" rel="stylesheet" />
<script src="Scripts/emojionearea.js"></script>-->

<style>

    body {
            background-image: url('@Url.Content("~/images/index.jpg")');
            background-position: center center fixed;
            background-size: cover;
            overflow-x: hidden;
        }

    div.panel-body {
        overflow: scroll;
        background: url('http://subtlepatterns.com/patterns/geometry2.png');
    }

    .dropbtn {
        background-color: #3498DB;
        color: white;
        padding: 16px;
        font-size: 16px;
        border: none;
        cursor: pointer;
    }

        /* Dropdown button on hover & focus */
        .dropbtn:hover, .dropbtn:focus {
            background-color: #2980B9;
        }

    /* The container <div> - needed to position the dropdown content */
    .dropdown {
        position: relative;
        display: inline-block;
    }

    /* Dropdown Content (Hidden by Default) */
    .dropdown-content {
        display: none;
        position: absolute;
        background-color: #f1f1f1;
        min-width: 160px;
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
        z-index: 1;
    }

        /* Links inside the dropdown */
        .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }

            /* Change color of dropdown links on hover */
            .dropdown-content a:hover {
                background-color: #ddd
            }

    /* Show the dropdown menu (use JS to add this class to the .dropdown-content container when the user clicks on the dropdown button) */
    .show {
        display: block;
    }


    .expand {
        font-weight: bold;
        font-style: italic;
        font-size: 12px;
        cursor: pointer;
    }

    .expandable {
        display: none;
    }

    /* Create three equal columns that floats next to each other */
    .column {
        float: left;
        padding: 15px;
        position:relative;
    }

    /* Clear floats after the columns */
    .row:after {
        content: "";
        display: table;
        clear: both;
    }

    #userChannels tr {
        background-color: #eee;
        border-top: 1px solid #fff;
        height: 30px;
    }

        #userChannels tr:hover {
            background-color: #ccc;
        }

    #userChannels th {
        background-color: #fff;
    }

    #userChannels th, #userChannels td {
        padding: 3px 5px;
    }

        #userChannels td:hover {
            cursor: pointer;
        }



    #ChannelUsers tr {
        background-color: #eee;
        border-top: 1px solid #fff;
        height: 30px;
    }

        #ChannelUsers tr:hover {
            background-color: #ccc;
        }

    #ChannelUsers th {
        background-color: #fff;
    }

    #ChannelUsers th, #ChannelUsers td {
        padding: 3px 5px;
    }

        #ChannelUsers td:hover {
            cursor: pointer;
        }
    .kickrow {
        width: 100px;
        background-color: grey;
        background-image: url('@Url.Content("~/images/kick.png")');
        background-repeat: no-repeat;
        background-size: 80%;
    }



    .searchcontainer {
        width: 100%;
        margin: auto;
        background-image: url('http://subtlepatterns.com/patterns/geometry2.png');
        overflow: hidden;
        background-repeat: no-repeat;
        background-size: cover;
        padding: 5%;
    }

        .searchcontainer input {
            background: #ffffff57;
            font-size: 20px;
            color: #fff;
            margin-left: auto;
            margin-right: auto;
            width: 90%;
        }

        .searchcontainer button {
            background-image: url('@Url.Content("~/images/search.svg")');
            background-repeat: no-repeat;
            background-color: #fff;
            background-position: center;
            width: 50px;
            height: 50px;
            border: none;
        }

            .searchcontainer button:hover {
                background-image: url('@Url.Content("~/images/search.svg")');
                background-repeat: no-repeat;
                background-color: #ffa;
                background-position: center;
                width: 50px;
                height: 50px;
                border: none;
            }


    #results {
        border-top: 2px solid #999;
        margin-left: auto;
        margin-right: auto;
        width: 70%;
        position:absolute;
    }

    .suggestions {
        padding: 15px;
        font-size: 15px;
        background: white;
        border-top: 1px solid #666;
        cursor: pointer;
        margin-left: auto;
        margin-right: auto;
        width: 90%;

    }

        .suggestions:hover {
            background-color: #1e4dd4;
        }

    .emphy {
        width: 50%;
        margin: 40px auto;
        text-align: center;
        color: white;
    }

    #searchInput:focus {
        background: url('@Url.Content("~/images/search.svg")') left no-repeat white;
        background-size: 20px;
        background-position: 10px;
        padding-left: 35px;
        width: 92%;
        font-size: 20px;
        color: #000;
    }

    .editableMessage:hover {
         background-color: rgba(244, 235, 158, 0.5);
    }

    #discussion {
        width:100%;
    }



</style>

<div class="modal" id="userProfile" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title" id="profileName">@_localizer.GetString("Vartotojo profilis")</h4>
            </div>
            <div class="modal-body">
                <img src='@Url.Content("~/images/avatar.png")' id="pfp" style="width:150px;height:150px; float:left;">
                <div id="userData" style="height:250px; padding-left: 160px;"></div>
            </div>
            <div class="modal-footer" style="height:130px">
                <div style="position:absolute;">
                    <p>@_localizer.GetString("Priskirti rolę"): </p>
                    <select class="form-control form-control-sm" id="rolesList">
                        @foreach (string s in roles)
                        {
                            roleVal++;
                            <option value="@roleVal">@s</option>
                        }
                    </select>
                    <button class="btn btn-default" onclick="assignRole('')" id="assignRole" style="margin-top:5px;">@_localizer.GetString("Priskirti")</button>
                </div>
                <button class="btn btn-default" onclick="callKick()" id="callKick">@_localizer.GetString("Išspirti")</button>
                <button class="btn btn-primary" data-dismiss="modal">@_localizer.GetString("Uždaryti")</button>
            </div>

        </div>
    </div>
</div>


<div class="modal" id="kickUser" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title" id="kickUserName">@_localizer.GetString("Ar tikrai norite išspirti vartotoją")</h4>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" data-dismiss="modal">@_localizer.GetString("Uždaryti")</button>
                <button class="btn btn-default" onclick="kickUser(id, name)" id="kickUsr">@_localizer.GetString("Išspirti")</button>
            </div>
        </div>
    </div>
</div>


<div class="modal" id="channelProfile" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title" id="channelName">@_localizer.GetString("Kanalas")</h4>
            </div>
            <div class="modal-body">
                <div id="channelData" style="height:80px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-default" onclick="callLeaveChannel()" id="callLeaveChannel">@_localizer.GetString("Palikti kanalą")</button>
                <button class="btn btn-default" onclick="callDeleteChannel()" id="callDelete">@_localizer.GetString("Naikinti kanalą")</button>
                <button class="btn btn-primary" data-dismiss="modal">@_localizer.GetString("Uždaryti")</button>
            </div>

        </div>
    </div>
</div>


<div class="modal" id="deleteChannel" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title" id="deleteChannelName">@_localizer.GetString("Ar tikrai norite pašalinti kanalą?")</h4>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" data-dismiss="modal">@_localizer.GetString("Uždaryti")</button>
                <button class="btn btn-default" onclick="deleteChannel(id)" id="deleteChn">@_localizer.GetString("Naikinti kanalą")</button>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="leaveChannel" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title" id="leaveChannelName">@_localizer.GetString("Ar tikrai norite palikti kanalą?")</h4>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" data-dismiss="modal">@_localizer.GetString("Uždaryti")</button>
                <button class="btn btn-default" onclick="leaveChannel(id)" id="leaveChn">@_localizer.GetString("Palikti kanalą")</button>
            </div>
        </div>
    </div>
</div>


<br><br>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-2">

            <div class="chat-panel panel panel-default">
                <h3 class="text-left">@_localizer.GetString("Vartotojo kanalai")</h3>
                <div class="chat-channels">


                    <div class="panel-body" id="chatChannels" style="height:250px;">

                        <table class="table" id="userChannels"></table>
                    </div>
                </div>
                <br>
                <p class="expand" id="expand-2"><input type="button" class="btn btn-warning btn-sm" id="getChannels" value="@_localizer.GetString("Naujas kanalas")"></p>
                <div class="expandable" id="expandable-2">
                    <input id="newChannel" type="text" onfocus="this.value=''" class="form-control input-sm" placeholder="@_localizer.GetString("Kanalo pavadinimas")" />
                    <br>
                    <input type="button" class="btn btn-warning btn-sm" id="createChannel" value="@_localizer.GetString("Kurti kanalą")">
                </div>
            </div>

            </div>
            <div class="col-md-8">
                <div class="chat-panel panel panel-default">
                    <h2>Studentų Chat'as</h2>
                    <div class="panel-heading">
                        @if (User.Identity.IsAuthenticated)
                        {
                            string laik = @_localizer.GetString("Prisijungęs kaip");
                            <h3 class="text-left"> @laik @User.Identity.Name</h3>
                        }
                        else
                        {
                            <h3 class="text-left">@_localizer.GetString("Prisijungęs kaip Guest") </h3>
                        }


                        <i class="fa fa-paper-plane fa-fw"></i>
                        <h3 id="selectedChannel"></h3>
                        <input type="text" class="navbar-form" placeholder="@_localizer.GetString("Ieškoti..")" id="searchbar">
                        <button class="btn btn-primary" onclick="searchMessages()">@_localizer.GetString("Ieškoti")</button>
                        <button id="cancelSearch" style="visibility:hidden">&times;</button>
                    </div>
                    <!-- /.panel-heading -->
<div class="panel-body" id="chat" style="height:400px;">
    <input type="hidden" id="displayname" />

    <table id="discussion"></table>
</div>
<!-- /.panel-body -->
<div class="panel-footer">
    <div class="input-group">
        <input id="message" type="text" name="message" class="form-control input-sm" placeholder="@_localizer.GetString("Rašykite žinutę čia...")" />

        <span class="input-group-btn">
            <input type="button" class="btn btn-warning btn-sm" id="sendmessage" value="@_localizer.GetString("Siųsti")">

        </span>
    </div>
</div>

<div>
    <p class="expand" id="expand-1">@_localizer.GetString("Naudojimosi informacija")</p>
</div>
<div class="expandable" id="expandable-1">
    <p>
        <b>@_localizer.GetString("Rašyti žinutes galima tik prisijungus ir pasirinkus kanalą.")</b><br>
        <b>@_localizer.GetString("Vartotojai turi roles:")</b><br>
        @_localizer.GetString("Kanalo kūrėjas - vartotojas, kuris sukūrė kanalą. Gali atlikti visus administravimo veiksmus, taip pat ir ištrinti kanalą.")<br>
        @_localizer.GetString("Administratorius - vartotojas, kuris administruoja kanalą. Gali atlikti visus administravimo veiksmus, taip pat ir priskirti roles.")<br>
        @_localizer.GetString("Moderatorius - vartotojas, kuris administruoja kanalą. Gali administruoti paparastų vartotojų žinutes.")<br>
        @_localizer.GetString("Vartotojas - paprastas vartotojas, gali tik rašyti, trinti, redaguoti savo žinutes.")<br>
        <hr>
        <b>@_localizer.GetString("Administravimo komandos, kurias gali naudoti kanalo kūrėjas:") </b><br>
        <i>-delete n</i><br>
        @_localizer.GetString("Ištrina n žinučių")<br>
        @_localizer.GetString("Pvz.") <br>
        -delete 10<br>
        -delete 5<br>
        -delete 1000<br>
        <br>
        @_localizer.GetString("Žinučių filtravimui visi vartotojai gali naudotis žinučių paieškos funkcija")<br>
    </p>
</div>

                </div>
            </div>
<div class="col-md-2">
    <div class="chat-panel panel panel-default">
        <div class="searchcontainer">

            <h3 class="text-left">@_localizer.GetString("Pridėti vartotoją")</h3>

            <input type="text" onfocus="this.value=''" id="searchInput" autocomplete="off">
            <div id="results"></div>
            <br>
            <br>


        </div>
        <h3 class="text-left">@_localizer.GetString("Vartotojai kanale")</h3>
        <div class="channel-users">
            <div class="panel-body" id="chatChannelUsers" style="height:250px;">

                <table class="table" id="ChannelUsers"></table>
            </div>
        </div>

    </div>
</div>
<!--Emoji dropdown menu. Pakolkas nesuristas su emojionarea js ir css failais.-->
            </div>
</div>
<div class="dropdown" style="visibility:hidden">
    <button onclick="myFunction()" class="dropbtn">Emoji</button>
    <div id="myDropdown" class="dropdown-content">
        <a href="#">Link 1</a>
        <a href="#">Link 2</a>
        <a href="#">Link 3</a>
    </div>
</div>

@section scripts {
    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/js/signalr/signalr.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <!--<script src="~/signalr/hubs"></script>-->
    <!--SignalR script to update the chat page and send messages.-->


    <script>
        let channels = new Array();
        let currentChannel = 0;
        const connection = new signalR.HubConnectionBuilder()
                .withUrl("/chatHub")
                .build();
        $(function () {


            // Reference the auto-generated proxy for the hub.
            // const chat = $.connection.chatHub;


            connection.start().catch(err => console.error(err.toString()));

            //var chat = $.connection.chatHub;
            // Create a function that the hub can call back to display messages.
            //chat.client.addNewMessageToPage = function (name, message) {
            connection.on('Send', (name, message, channel) => {

            // Add the message to the page.

            let userName = '@User.Identity.Name';

            if (userName == "") {
                userName = "Guest";
                }
                if (channel === currentChannel) {
                    loadChatLog(currentChannel);
                }

            });

            connection.on('AddChannelUser', (channel) => {
                console.log(currentChannel);
                if (currentChannel === channel) {
                    getChannelUsers();

                }

            });

            connection.on('AddChannelToUser', (userName) => {
                if ('@User.Identity.Name' === userName) {
                    getUserChannels();
                }

            });


            connection.on('KickChannelUser', (userName, channel) => {
                if ('@User.Identity.Name' === userName && currentChannel === channel) {
                    getUserChannels();
                    getChannelUsers();
                    $('#discussion').empty();
                    $('#selectedChannel').empty();
                    currentChannel = 0;
                }
                else if (currentChannel === channel) {
                    getChannelUsers();

                }

            });


            connection.on('EditMessage', (value, id, channel) => {

                if (validURL(value)) {
                    if (!checkURL(value)) {
                        
                            value = "<a href='" + value + "' target='_blank'>" + value + "</a>";
                        
                       
                    }
                    else {
                        value = "<a href='" + value + "' target='_blank'>" + value + "</a><br><img width='200px' src='" + value + "'></img>";
                    }
                }

                if (channel === currentChannel) {
                    
                    
                    if ($("#" + id).find('textarea')[0]) {
                        let txtArea = $("#" + id).find('textarea')[0].outerHTML;

                        $("#" + id).html(value + txtArea);
                    }
                    else {
                        $("#" + id).html(value);
                    }
                    
                }
            });

            connection.on('DeleteMessage', (id, channel) => {
                if (channel === currentChannel) {

                    $("#content" + id).parent().prev().remove();
                    $("#content" + id).parent().remove();

                }
            });

            connection.on('DeleteChannel', (id) => {
                let foundChn = false;
                channels.forEach((element) => {
                    if (element.Item1 === id) {
                        foundChn = true;
                    }
                });
                if (foundChn) {
                    if (currentChannel === id) {
                        $('#discussion').empty();
                        $('#selectedChannel').empty();
                        $('#ChannelUsers').empty();
                        currentChannel = 0;
                    }
                    getUserChannels();
                   // $("#channel" + id).remove();

                }
            });



            connection.on('LeaveChannel', (id, userName) => {
                if ('@User.Identity.Name' === userName) {
                    let foundChn = false;
                    channels.forEach((element) => {
                        if (element.Item1 === id) {
                            foundChn = true;
                        }
                    });
                    if (foundChn) {
                        if (currentChannel === id) {
                            $('#discussion').empty();
                            $('#selectedChannel').empty();
                            $('#ChannelUsers').empty();
                            currentChannel = 0;
                        }
                        getUserChannels();
                        // $("#channel" + id).remove();

                    }
                }
                else if (currentChannel === id) {
                    getChannelUsers();
                }
            });

            connection.on('SendNotification', (channelId) => {
                if (channelId !== currentChannel) {

                    $("#channel" + channelId).css("background-color", "yellow");

                     $.ajax({
                        url: '@Url.Action("SendNotification")',
                        type: "POST",
                         data: { channel: channelId, userName: "@User.Identity.Name" },
                        dataType: "json",
                        success: function (response) {
                            console.log("success send notification! " + response);
                        },
                        failure: function (response) {
                            console.log("failure send message!");
                        }
                    });

                }
            });

            connection.on('DeleteMessagesCommand', (channelId, count) => {
                if (channelId === currentChannel) {
                    let last1;
                    let last2;
                    for (i = 0; i < count * 2 + 2; i++) {
                        if (i == 0) {
                            last1 = $('#discussion tr:last');
                        }
                        if (i == 1) {
                            last2 = $('#discussion tr:last');
                        }
                        $('#discussion tr:last').remove();
                    }
                    $('#discussion').append(last2);
                    $('#discussion').append(last1);

                }
            });

            //};
            // Get the user name and store it to prepend to messages.
            //$('#displayname').val(prompt('Enter your name:', ''));
            // Set initial focus to message input box.
            $('#message').focus();
            // Start the connection.
            //$connection.hub.start().done(function () {
            $('#sendmessage').click(function () {
                    let userName = '@User.Identity.Name';
                    let message = $('#message').val();
                    if (userName == "") {
                        userName = "Guest";
                    }
                    // Call the Send method on the hub.
                // chat.server.send($('#displayname').val(), $('#message').val());


                if (message.startsWith("-delete")) {
                    let count = message.split(" ")[1];
                    deleteMessagesCommand(count);
                }

                //Save sent message in the database using ajax request
                $.ajax({
                    url: '@Url.Action("Send")',
                    type: "POST",
                    data: { name: userName, text: message, channelId: currentChannel },
                    dataType: "json",
                    success: function (response) {
                        console.log("success send message!");
                        connection.invoke('Send', userName, message, currentChannel);
                        connection.invoke('SendNotification', currentChannel);
                        // Clear text box and reset focus for next comment.
                        $('#message').val('').focus();

                    },
                    failure: function (response) {
                        console.log("failure send message!");
                    }

                });

                updateScroll();
                });
            //});
            //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////Adds a emoji bar function


            $('#createChannel').click(function () {

                let channelName = $('#newChannel').val();
                if (channelName.length >= 1) {
                    $.ajax({
                        url: '@Url.Action("CreateChannel")',
                        type: "POST",
                        data: { name: channelName, userName: "@User.Identity.Name" },
                        dataType: "json",
                        success: function (response) {
                            console.log("success create channel! " + response);
                            $('#userChannels').empty()
                            getUserChannels();

                           // connection.invoke('AddChannelToUser', channelName, '@User.Identity.Name');
                        },
                        failure: function (response) {
                            console.log("failure send message!");
                        }

                    });
                }
            });



            getUserChannels();

            let lastentry = "";
            $('#searchInput').keyup(function (event) {
                let newText = $('#searchInput').val();
                $('#results').empty();
                if (newText != lastentry && newText.length >= 1) {

                    fetchData($(this).val());
                }
                lastentry = $('#searchInput').val();
            });


            $("#cancelSearch").click(function () {
                loadChatLog(currentChannel);
                $("#cancelSearch").css("visibility", "hidden");
            });

            //On enter key press when inside input field send message
            $('#message').keypress(function (e) {
                var key = e.which;
                if (key == 13)  // the enter key code
                {
                    $('#sendmessage').click();
                    return false;
                }
            });

            $('html').click(function (e) {
                if (e.target.className !== "suggestions") {
                    $('#results').empty();
                }
            });
        });
        // This optional function html-encodes messages for display in the page.
        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }


        function updateScroll() {
            var element = document.getElementById("chat");
            element.scrollTop = element.scrollHeight;
                }

        function selectChannel(id) {
            currentChannel = id;
            getUserChannels();
            channels.forEach((element) => {
                if (element.Id === id) {
                   // $("#selectedChannel").text("Pasirinktas kanalas: " + element.Name);
                   // $("#channel" + id).css("background-color", "#9999ff");
                    removeNotification(id);
                }
            });
            loadChatLog(currentChannel);
            getChannelUsers();
            removeNotification(id);
            $("#cancelSearch").css("visibility", "hidden");
        }


        function loadChatLog(channel) {
            $.ajax({
            url: '@Url.Action("GetChatMessages")',
                type: "POST",
                data: { chatId: channel, userName: "@User.Identity.Name" },
            dataType: "json",
            success: function (response) {
                console.log("success get messages! " + response + " response");
                msgs = JSON.parse(response);
                $('#discussion').empty();
                console.log(msgs);
                msgs.forEach((element) => {
                    if ("@User.Identity.Name" === element.Item2) {
                        if (validURL(element.Item5)) {
                            if (!checkURL(element.Item5)) {
                                $('#discussion').append("<tr style='color:green; text-align:left; width:100%; display:inline-table;'><th><img src='/avatars/" + element.Item3 + "' style='width:40px;' id='profile-pic" +
                                    element.Item1 + "'><strong> " + htmlEncode(element.Item2) +
                                    "</strong> " + " " + formatDate(element.Item4) + "</th></tr><tr class='editableMessage' style='color:black; text-align:left; width:100%; display:table-row;'><th id='content" + element.Item1 +
                                    "' style='word-break: break-word; width:100%;'><a href='" + element.Item5 + "'target='_blank'>" + element.Item5 + "</a> <textarea class='form-control' id='edit" +
                                    element.Item1 + "' style='visibility: hidden; width: 0; height: 0'>" +
                                    element.Item5 + "</textarea></th><th style='display:inline-flex;'><button id='saveEdit" +
                                    element.Item1 + "' onclick='saveEdit(" + element.Item1 + ")' style='visibility: hidden; width: 0;'>@_localizer.GetString("Išsaugoti")</button><button id='editMessage" +
                                    element.Item1 + "' onclick='editMessage(" + element.Item1 + ")'  style='float:right;'>@_localizer.GetString("Redaguoti")</button><button id='deleteMessage" +
                                    element.Item1 + "' onclick='deleteMessage(" + element.Item1 + ")'  style='float:right;'>@_localizer.GetString("Trinti")</button></th></tr>");
                            }
                            else {
                                $('#discussion').append("<tr style='color:green; text-align:left; width:100%; display:inline-table;'><th><img src='/avatars/" + element.Item3 + "' style='width:40px;' id='profile-pic" +
                                    element.Item1 + "'><strong> " + htmlEncode(element.Item2) +
                                    "</strong> " + " " + formatDate(element.Item4) + "</th></tr><tr class='editableMessage' style='color:black; text-align:left; width:100%; display:table-row;'><th id='content" + element.Item1 +
                                    "' style='word-break: break-word; width:100%;'><a href='" + element.Item5 + "'target='_blank'>" + element.Item5 + "</a><br><img width='200px' src='" + element.Item5 + "'></img> <textarea class='form-control' id='edit" +
                                    element.Item1 + "' style='visibility: hidden; width: 0; height: 0'>" +
                                    element.Item5 + "</textarea></th><th style='display:inline-flex;'><button id='saveEdit" +
                                    element.Item1 + "' onclick='saveEdit(" + element.Item1 + ")' style='visibility: hidden; width: 0;'>@_localizer.GetString("Išsaugoti")</button><button id='editMessage" +
                                    element.Item1 + "' onclick='editMessage(" + element.Item1 + ")'  style='float:right;'>@_localizer.GetString("Redaguoti")</button><button id='deleteMessage" +
                                    element.Item1 + "' onclick='deleteMessage(" + element.Item1 + ")'  style='float:right;'>@_localizer.GetString("Trinti")</button></th></tr>");
                            }
                        }
                        else {
                            $('#discussion').append("<tr style='color:green; text-align:left; width:100%; display:inline-table;'><th><img src='/avatars/" + element.Item3 + "' style='width:40px;' id='profile-pic" +
                                element.Item1 + "'><strong> " + htmlEncode(element.Item2) +
                                "</strong> " + " " + formatDate(element.Item4) + "</th></tr><tr class='editableMessage' style='color:black; text-align:left; width:100%; display:table-row;'><th id='content" + element.Item1 +
                                "' style='word-break: break-word; width:100%;'>" + htmlEncode(element.Item5) + "<textarea class='form-control' id='edit" +
                                element.Item1 + "' style='visibility: hidden; width: 0; height: 0'>" +
                                element.Item5 + "</textarea></th><th style='display:inline-flex;'><button id='saveEdit" +
                                element.Item1 + "' onclick='saveEdit(" + element.Item1 + ")' style='visibility: hidden; width: 0;'>@_localizer.GetString("Išsaugoti")</button><button id='editMessage" +
                                element.Item1 + "' onclick='editMessage(" + element.Item1 + ")'  style='float:right;'>@_localizer.GetString("Redaguoti")</button><button id='deleteMessage" +
                                element.Item1 + "' onclick='deleteMessage(" + element.Item1 + ")'  style='float:right;'>@_localizer.GetString("Trinti")</button></th></tr>");
                        }
                    }
                    else {
                        if (element.Item6 > element.Item7) {
                            if (validURL(element.Item5)) {
                                if (!checkURL(element.Item5)) {
                                    $('#discussion').append("<tr style='color:green; text-align:left; width:100%; display:inline-table;'><th><img src='/avatars/" + element.Item3 + "' style='width:40px;' id='profile-pic" +
                                        element.Item1 + "'><strong> " + htmlEncode(element.Item2) +
                                        "</strong>" + " " + formatDate(element.Item4) + "</th></tr><tr class='otherMessage' style='color:black; text-align:left; width:100%; display:table-row;'><th id='content" + element.Item1 +
                                        "' style='word-break: break-word; width:100%;'><a href='" + element.Item5 + "'target='_blank'>" + element.Item5 + "</a></th><th></th></tr>");
                                }
                                else {
                                    $('#discussion').append("<tr style='color:green; text-align:left; width:100%; display:inline-table;'><th><img src='/avatars/" + element.Item3 + "' style='width:40px;' id='profile-pic" +
                                        element.Item1 + "'><strong> " + htmlEncode(element.Item2) +
                                        "</strong>" + " " + formatDate(element.Item4) + "</th></tr><tr class='otherMessage' style='color:black; text-align:left; width:100%; display:table-row;'><th id='content" + element.Item1 +
                                        "' style='word-break: break-word; width:100%;'><a href='" + element.Item5 + "'target='_blank'>" + element.Item5 + "</a><br><img width='200px' src='" + element.Item5 + "'></img></th><th></th></tr>");
                                }
                            }
                            else {
                                $('#discussion').append("<tr style='color:green; text-align:left; width:100%; display:inline-table;'><th><img src='/avatars/" + element.Item3 + "' style='width:40px;' id='profile-pic" +
                                    element.Item1 + "'><strong> " + htmlEncode(element.Item2) +
                                    "</strong>" + " " + formatDate(element.Item4) + "</th></tr><tr class='otherMessage' style='color:black; text-align:left; width:100%; display:table-row;'><th id='content" + element.Item1 +
                                    "' style='word-break: break-word; width:100%;'>" + htmlEncode(element.Item5) + "</th><th></th></tr>");
                            }
                        }
                        else {
                            if (validURL(element.Item5)) {
                                if (!checkURL(element.Item5)) {
                                    $('#discussion').append("<tr style='color:green; text-align:left; width:100%; display:inline-table;'><th><img src='/avatars/" + element.Item3 + "' style='width:40px;' id='profile-pic" +
                                        element.Item1 + "'><strong> " + htmlEncode(element.Item2) +
                                        "</strong> " + " " + formatDate(element.Item4) + "</th></tr><tr class='editableMessage' style='color:black; text-align:left; width:100%; display:table-row;'><th id='content" + element.Item1 +
                                        "' style='word-break: break-word; width:100%;'><a href='" + element.Item5 + "'target='_blank'>" + element.Item5 + "</a></th><th style='display:inline-flex;'><button id='deleteMessage" +
                                        element.Item1 + "' onclick='deleteOtherMessage(" + element.Item1 + ", &quot;" + element.Item2 + "&quot;)'  style='float:right;'>@_localizer.GetString("Trinti")</button></th></tr>");
                                }
                                else {
                                    $('#discussion').append("<tr style='color:green; text-align:left; width:100%; display:inline-table;'><th><img src='/avatars/" + element.Item3 + "' style='width:40px;' id='profile-pic" +
                                        element.Item1 + "'><strong> " + htmlEncode(element.Item2) +
                                        "</strong> " + " " + formatDate(element.Item4) + "</th></tr><tr class='editableMessage' style='color:black; text-align:left; width:100%; display:table-row;'><th id='content" + element.Item1 +
                                        "' style='word-break: break-word; width:100%;'><a href='" + element.Item5 + "'target='_blank'>" + element.Item5 + "</a><br><img width='200px' src='" + element.Item5 + "'></img></th><th style='display:inline-flex;'><button id='deleteMessage" +
                                        element.Item1 + "' onclick='deleteOtherMessage(" + element.Item1 + ", &quot;" + element.Item2 + "&quot;)'  style='float:right;'>@_localizer.GetString("Trinti")</button></th></tr>");
                                }
                            }
                            else {
                                $('#discussion').append("<tr style='color:green; text-align:left; width:100%; display:inline-table;'><th><img src='/avatars/" + element.Item3 + "' style='width:40px;' id='profile-pic" +
                                    element.Item1 + "'><strong> " + htmlEncode(element.Item2) +
                                    "</strong> " + " " + formatDate(element.Item4) + "</th></tr><tr class='editableMessage' style='color:black; text-align:left; width:100%; display:table-row;'><th id='content" + element.Item1 +
                                    "' style='word-break: break-word; width:100%;'>" + htmlEncode(element.Item5) + "</th><th style='display:inline-flex;'><button id='deleteMessage" +
                                    element.Item1 + "' onclick='deleteOtherMessage(" + element.Item1 + ", &quot;" + element.Item2 + "&quot;)'  style='float:right;'>@_localizer.GetString("Trinti")</button></th></tr>");
                            }
                            }
                    }
                });
                updateScroll();
            },
            failure: function (response) {
                console.log("failure getting messages!");
            }

            });
        }


        async function getUsersJson() {
            let usersjson = null;
            return $.ajax({
                    url: '@Url.Action("GetUsersJson")',
                        type: "POST",
                    dataType: "json",
                    success: function (response) {
                        console.log("success get messages! " + response + " response");
                        usersjson = JSON.parse(response);

                    },
                    failure: function (response) {
                        console.log("failure getting messages!");
                    }

            }).then(response => usersjson);
        }

        async function fetchData(search) {

            //let search = document.getElementById("searchInput").value;
            console.log(search);
            let data = await getUsersJson();
            if (!$('#results').is(':empty')) {
                $('#results').empty();
            }

            let dataArray = new Array();

            data.forEach((element) => {
                if (element.startsWith(search)) {
                    dataArray.push(element);
                }
            });

            let resultLength = dataArray.length;

            if (resultLength > 8) {
                resultLength = 8;
            }


            for (i = 0; i < resultLength; i++) {
                let node = document.createElement("div")//("<div class='suggestions' onclick='selectSuggestion()'></div>");

                node.setAttribute("class", "suggestions");
                let theFunction = "selectSuggestion(\"" + dataArray[i] + "\")";
                //alert(theFunction);
                node.setAttribute("onclick", theFunction);

                let img = document.createElement('img');
                img.src = '@Url.Content("~/images/prideti.png")';
                img.width = "15";
                node.appendChild(img);
                node.appendChild(document.createTextNode(dataArray[i]));

                document.getElementById('results').appendChild(node);
                //$('#suggestion' + i).append(data.results[i].original_title);
                //$('#suggestion' + i).append("</br>");
                //$('#suggestion' + i).append(data.results[i].vote_average + " Rating, ");
                //$('#suggestion' + i).append(new Date(data.results[i].release_date).getFullYear());
                //$('#suggestion' + i).append("</br>");
                //$('#results' + i).append("</div>");

            }


            console.log(dataArray);

        }

        function selectSuggestion(userNm) {

            $.ajax({
                url: '@Url.Action("AddUserToChannel")',
                type: "POST",
                data: { userName: userNm, inviterName: "@User.Identity.Name", channelId: currentChannel },
                dataType: "json",
                success: function (response) {

                    console.log("success add user! " + response + " response");
                    connection.invoke('AddChannelUser', currentChannel);
                    connection.invoke('AddChannelToUser', userNm);
                }
            });
            $('#results').empty();
            $('#searchInput').empty();
        }


        $('.expand').click(function () {
            target_num = $(this).attr('id').split('-')[1];
            content_id = '#expandable-'.concat(target_num);
            $(content_id).slideToggle('fast');
            });




            function getChannelUsers() {
                 $.ajax({
                    url: '@Url.Action("GetChannelUsers")',
                        type: "POST",
                     data: { chatId: currentChannel, userName: "@User.Identity.Name" },
                    dataType: "json",
                    success: function (response) {

                        let users = JSON.parse(response);
                        console.log("success get messages! " + users + " response ilgis " + users.length);
                        $('#ChannelUsers').empty()
                        users.forEach((element) => {
                            //$("#ChannelUsers").append("<tr><td>" + element.UserName + "</td> <td class='kickrow' onclick=\"kickUser('" + element.Id + "')\">        </td></tr>");
                            $("#ChannelUsers").append("<tr><td style='word-break: break-word;'  onclick='getUserProfile(&quot;" + element.Id + "&quot;)'>" + element.UserName + "</td></tr>");
                        });

                    },
                    failure: function (response) {
                        console.log("failure getting messages!");
                    }

                });

            }


        function kickUser(uId, uName) {

                 $.ajax({
                    url: '@Url.Action("KickChannelUser")',
                     type: "POST",
                     data: { channelId: currentChannel, userId: uId, caller: "@User.Identity.Name" },
                    dataType: "json",
                     success: function (response) {
                         console.log("kick user success " + response);
                       /* let users = JSON.parse(response);
                        console.log("success get messages! " + msgs + " response ilgis " + msgs.length);
                        $('#ChannelUsers').empty()
                        msgs.forEach((element) => {

                            $("#ChannelUsers").append("<tr><td>" + element.UserName + "</td> <td class='kickrow' onclick=\"kickUser('" + element.Id +  "')\">        </td></tr>");
                        });*/
                         $('#kickUser').modal('toggle');
                         connection.invoke('KickChannelUser', uName, currentChannel);
                    },
                    failure: function (response) {
                        console.log("failure getting messages!");
                    }

                    });
        }

        function callKick() {
            $('#userProfile').modal('toggle');
            $("#kickUser").modal();
        }

            function getUserChannels() {
                $.ajax({
                    url: '@Url.Action("GetUserChannels")',
                    type: "POST",
                    data: { userName: "@User.Identity.Name" },
                    dataType: "json",
                    success: function (response) {
                        console.log("success send message! " + response + " response");
                        channels = JSON.parse(response);
                        console.log("success send message! " + channels + " channels response " + channels.length);
                        $("#userChannels").empty();
                        for (i = 0; i < channels.length; i++) {
                            console.log(channels[i]);
                            if (channels[i].Item3 === false && channels[i].Item1 !== currentChannel) {
                                $("#userChannels").append("<tr id='channel" + channels[i].Item1 + "'><td style='word-break: break-word;' onclick='selectChannel(" + channels[i].Item1 + ")'>" + channels[i].Item2 + "</td><td style='background:green; width:25px;' onclick='getChannelSettings(" + channels[i].Item1 + ")'></td></tr>");
                            }
                            else if (channels[i].Item1 === currentChannel) {
                                $("#userChannels").append("<tr style='background-color:#9999ff' id='channel" + channels[i].Item1 + "'><td style='word-break: break-word;' onclick='selectChannel(" + channels[i].Item1 + ")'>" + channels[i].Item2 + "</td><td style='background:green; width:25px;' onclick='getChannelSettings(" + channels[i].Item1 + ")'></td></tr>");
                            }
                            else {
                                $("#userChannels").append("<tr style='background-color:yellow' id='channel" + channels[i].Item1 + "'><td style='word-break: break-word;' onclick='selectChannel(" + channels[i].Item1 + ")'>" + channels[i].Item2 + "</td><td style='background:green; width:25px;' onclick='getChannelSettings(" + channels[i].Item1 + ")'></td></tr>");
                            }
                        }
                        //selectChannel(channels[0].Id);
                        if (currentChannel === 0) {
                            selectChannel(channels[0].Item1);
                        }
                    },
                    failure: function (response) {
                        console.log("failure send message!");
                    }

                });
            }

            function editMessage(id) {
                let elId = "edit" + id;
                let contId = "content" + id;
                let editbtnId = "editMessage" + id;
                let deletebtnId = "deleteMessage" + id;
                let saveEditbtnId = "saveEdit" + id;
                $("#" + elId).css("visibility", "visible");
                $("#" + elId).css("width", "-webkit-fill-available");
                $("#" + elId).css("height", "fit-content");
                $("#" + saveEditbtnId).css("visibility", "visible");
                $("#" + saveEditbtnId).css("width", "fit-content");
                $("#" + contId).css("width", "0");
                $("#" + contId).css("visibility", "hidden");
                $("#" + editbtnId).css("width", "0");
                $("#" + editbtnId).css("visibility", "hidden");
                $("#" + deletebtnId).css("width", "0");
                $("#" + deletebtnId).css("visibility", "hidden");
            }


            function saveEdit(id) {
                let elId = "edit" + id;
                let value = $("#" + elId).val();
                let contId = "content" + id;
                let editbtnId = "editMessage" + id;
                let deletebtnId = "deleteMessage" + id;
                let saveEditbtnId = "saveEdit" + id;
                //alert("save edit " + id);
                $.ajax({
                    url: '@Url.Action("EditMessage")',
                        type: "POST",
                     data: {messageId: id, message: value, userName: "@User.Identity.Name" },
                    dataType: "json",
                    success: function (response) {
                        $("#" + contId).css("width", "100%");
                        $("#" + contId).css("visibility", "visible");
                        $("#" + editbtnId).css("width", "fit-content");
                        $("#" + editbtnId).css("visibility", "visible");
                        $("#" + deletebtnId).css("width", "fit-content");
                        $("#" + deletebtnId).css("visibility", "visible");
                        $("#" + elId).css("visibility", "hidden");
                        $("#" + elId).css("width", "0");
                        $("#" + elId).css("height", "0");
                        $("#" + saveEditbtnId).css("visibility", "hidden");
                        $("#" + saveEditbtnId).css("width", "0");
                        $("#" + elId).html(value);
                        $("#" + contId).html($("#" + elId).parent().html());
                        connection.invoke('EditMessage', value, contId, currentChannel);
                    },
                    failure: function (response) {
                        console.log("failure getting messages!");
                    }

                    });
            }


            function getUserProfile(id) {


                $.ajax({
                    url: '@Url.Action("GetUserProfile")',
                    type: "POST",
                    data: { userId: id, channelId: currentChannel },
                    dataType: "json",
                    success: function (response) {
                        $("#userProfile").modal();
                        console.log(response);
                       // let channel = JSON.parse(response);
                        console.log("success get messages! " + response + " response ilgis " + response.length);
                        $('#userData').empty();
                        $('#profileName').text("@_localizer.GetString("Vartotojo") " + response.item1 + " profilis");
                        $('#userData').append("<p><b>@_localizer.GetString("Vardas"): </b>" + response.item2 + "</p>");
                        $('#userData').append("<p><b>@_localizer.GetString("Pavardė"): </b>" + response.item3 + "</p>");
                        if (response.item4 === "1850-01-01") {
                            $('#userData').append("<p><b>@_localizer.GetString("Gimimo data"): </b>(Paslėpta)</p>");
                        }
                        else {
                            $('#userData').append("<p><b>@_localizer.GetString("Gimimo data"): </b>" + response.item4 + "</p>");
                        }
                        $('#userData').append("<p><b>@_localizer.GetString("Kanalo rolė"): </b>" + response.item6 + "</p>");
                        $('#userData').append("<p><b>@_localizer.GetString("Prisijungė prie kanalo"): </b>" + response.rest.item1 + "</p>");
                        $('#userData').append("<p><b>@_localizer.GetString("Parašė žinučių kanale"): </b>" + response.item7 + "</p>");
                        $("#pfp").attr("src", "/avatars/" + response.item5);
                        $("#kickUsr").attr("onclick", "kickUser('" + id + "', '" + response.item1 + "')");
                        $("#assignRole").attr("onclick", "assignRole('" + id + "')");
                        $('#kickUserName').text("@_localizer.GetString("Ar tikrai norite išspirti vartotoją") " + response.item1);
                        console.log("--------------- " + response.item7);
                    },
                    failure: function (response) {
                        console.log("failure getting messages!");
                    }

                    });




            }

        function deleteMessage(id) {
              $.ajax({
                    url: '@Url.Action("DeleteMessage")',
                  type: "POST",
                  data: { messageId: id, userName: "@User.Identity.Name", caller: "@User.Identity.Name", channel: currentChannel },
                    dataType: "json",
                     success: function (response) {
                         console.log("kick user success " + response);
                       /* let users = JSON.parse(response);
                        console.log("success get messages! " + msgs + " response ilgis " + msgs.length);
                        $('#ChannelUsers').empty()
                        msgs.forEach((element) => {

                            $("#ChannelUsers").append("<tr><td>" + element.UserName + "</td> <td class='kickrow' onclick=\"kickUser('" + element.Id +  "')\">        </td></tr>");
                        });*/
                         connection.invoke('DeleteMessage', id, currentChannel);
                    },
                    failure: function (response) {
                        console.log("failure getting messages!");
                    }

                    });
        }


           function deleteOtherMessage(id, user) {
              $.ajax({
                    url: '@Url.Action("DeleteMessage")',
                     type: "POST",
                  data: { messageId: id, userName: user, caller: "@User.Identity.Name", channel: currentChannel },
                    dataType: "json",
                     success: function (response) {
                         console.log("kick user success " + response);
                       /* let users = JSON.parse(response);
                        console.log("success get messages! " + msgs + " response ilgis " + msgs.length);
                        $('#ChannelUsers').empty()
                        msgs.forEach((element) => {

                            $("#ChannelUsers").append("<tr><td>" + element.UserName + "</td> <td class='kickrow' onclick=\"kickUser('" + element.Id +  "')\">        </td></tr>");
                        });*/
                         connection.invoke('DeleteMessage', id, currentChannel);
                    },
                    failure: function (response) {
                        console.log("failure getting messages!");
                    }

                    });
        }


         function deleteChannel(id) {

                 $.ajax({
                    url: '@Url.Action("DeleteChannel")',
                     type: "POST",
                     data: { channelId: id, userName: "@User.Identity.Name" },
                    dataType: "json",
                     success: function (response) {
                         console.log("delete channel success " + response);
                       /* let users = JSON.parse(response);
                        console.log("success get messages! " + msgs + " response ilgis " + msgs.length);
                        $('#ChannelUsers').empty()
                        msgs.forEach((element) => {

                            $("#ChannelUsers").append("<tr><td>" + element.UserName + "</td> <td class='kickrow' onclick=\"kickUser('" + element.Id +  "')\">        </td></tr>");
                        });*/
                         $('#deleteChannel').modal('toggle');
                         connection.invoke('DeleteChannel', id);
                    },
                    failure: function (response) {
                        console.log("failure getting messages!");
                    }

                    });
        }

        function callDeleteChannel() {
            $('#channelProfile').modal('toggle');
            $("#deleteChannel").modal();
        }


        function getChannelSettings(id){
             $.ajax({
                    url: '@Url.Action("GetChannelSettings")',
                     type: "POST",
                     data: { channelId: id, userName: "@User.Identity.Name" },
                    dataType: "json",
                     success: function (response) {
                         $("#channelProfile").modal();
                         console.log(response);
                        // let channel = JSON.parse(response);
                         console.log("success get messages! " + response + " response ilgis " + response.length);
                         $('#channelData').empty();
                         $('#channelName').text("@_localizer.GetString("Kanalas") " + response.item2);
                         $('#channelData').append("<p><b>@_localizer.GetString("Kanalo sukūrimo data"): </b>" + response.item6 + "</p>");
                         $('#channelData').append("<p><b>@_localizer.GetString("Kanale parašyta žinučių"): </b>" + response.item3 + "</p>");
                         $('#channelData').append("<p><b>@_localizer.GetString("Aktyviausias vartotojas"): </b>" + response.item4 + " (" + response.item5 + " žinučių)</p>");
                        // $('#channelData').append("<p><b>Gimimo data: </b>" + response.item5 + "</p>");
                         $("#deleteChn").attr("onclick", "deleteChannel(" + response.item1 + ")");
                         $('#deleteChannelName').text("@_localizer.GetString("Ar tikrai norite pašalinti kanalą") " + response.item2 + "?");
                         $("#leaveChn").attr("onclick", "leaveChannel(" + response.item1 + ")");
                         $('#leaveChannelName').text("@_localizer.GetString("Ar tikrai norite palikti kanalą") " + response.item2 + "?");

                         //liktu isverst, "Kanalas", "Ar tikrai norite pasalinti/palikti kanala"
                         //tie patys kintamieji ir i ekrana keliauja ir naudojami uzklausoje
                         //pradejus verst "pradingsta" funkcionalumas. Norint 100% isverst galima zaist dar
                         //vieno zodzio "Kanalas"
                         //$('#channelName').text(@_localizer.GetString("Kanalas ") +  " "  + channel.Name);
                         //$('#deleteChannelName').text(@_localizer.GetString("Ar tikrai norite pašalinti kanalą") + " " + channel.Name + "?");
                         //$('#leaveChannelName').text(@_localizer.GetString("Ar tikrai norite palikti kanalą") + " " + channel.Name + "?");
                         //plius nepamirs reiksmiu resursu faile (kol kas irasytos)
                    },
                    failure: function (response) {
                        console.log("failure getting messages!");
                    }

                    });
        }


        function assignRole(id) {
            let selectVal = $("#rolesList").val();
             $.ajax({
                    url: '@Url.Action("AssignRole")',
                 type: "POST",
                 data: { receiverId: id, callerName: "@User.Identity.Name", channelId: currentChannel, roleValue: selectVal },
                    dataType: "json",
                     success: function (response) {
                         $("#userProfile").modal('toggle');

                    },
                    failure: function (response) {
                        console.log("failure getting messages!");
                    }

                    });
        }

     function leaveChannel(id) {
            $.ajax({
                    url: '@Url.Action("LeaveChannel")',
                     type: "POST",
                     data: { channelId: id, userName: "@User.Identity.Name" },
                    dataType: "json",
                     success: function (response) {
                         $("#leaveChannel").modal('toggle');
                         connection.invoke('LeaveChannel', id, "@User.Identity.Name");
                    },
                    failure: function (response) {
                        console.log("failure getting messages!");
                    }

                    });
        }

        function callLeaveChannel() {
            $('#channelProfile').modal('toggle');
            $("#leaveChannel").modal();
        }


        function removeNotification(channelId) {
             $.ajax({
                        url: '@Url.Action("RemoveNotification")',
                        type: "POST",
                         data: { channel: channelId, userName: "@User.Identity.Name" },
                        dataType: "json",
                        success: function (response) {
                            console.log("success send notification! " + response);
                        },
                        failure: function (response) {
                            console.log("failure send message!");
                        }
                    });
        }


        function searchMessages() {
            let value = $("#searchbar").val();
            $.ajax({
                url: '@Url.Action("SearchInChat")',
                type: "POST",
                data: { channel: currentChannel, userName: "@User.Identity.Name", searchWord: value },
                dataType: "json",
                success: function (response) {
                let msgs = JSON.parse(response);
                $('#discussion').empty();
                msgs.forEach((element) => {
                   if ("@User.Identity.Name" === element.Item2) {
                        if (validURL(element.Item5)) {
                            if (!checkURL(element.Item5)) {
                                $('#discussion').append("<tr style='color:green; text-align:left; width:100%; display:inline-table;'><th><img src='/avatars/" + element.Item3 + "' style='width:40px;' id='profile-pic" +
                                    element.Item1 + "'><strong> " + htmlEncode(element.Item2) +
                                    "</strong> " + " " + formatDate(element.Item4) + "</th></tr><tr class='editableMessage' style='color:black; text-align:left; width:100%; display:table-row;'><th id='content" + element.Item1 +
                                    "' style='word-break: break-word; width:100%;'><a href='" + element.Item5 + "'target='_blank'>" + element.Item5 + "</a> <textarea class='form-control' id='edit" +
                                    element.Item1 + "' style='visibility: hidden; width: 0; height: 0'>" +
                                    element.Item5 + "</textarea></th><th style='display:inline-flex;'><button id='saveEdit" +
                                    element.Item1 + "' onclick='saveEdit(" + element.Item1 + ")' style='visibility: hidden; width: 0;'>@_localizer.GetString("Išsaugoti")</button><button id='editMessage" +
                                    element.Item1 + "' onclick='editMessage(" + element.Item1 + ")'  style='float:right;'>@_localizer.GetString("Redaguoti")</button><button id='deleteMessage" +
                                    element.Item1 + "' onclick='deleteMessage(" + element.Item1 + ")'  style='float:right;'>@_localizer.GetString("Trinti")</button></th></tr>");
                            }
                            else {
                                $('#discussion').append("<tr style='color:green; text-align:left; width:100%; display:inline-table;'><th><img src='/avatars/" + element.Item3 + "' style='width:40px;' id='profile-pic" +
                                    element.Item1 + "'><strong> " + htmlEncode(element.Item2) +
                                    "</strong> " + " " + formatDate(element.Item4) + "</th></tr><tr class='editableMessage' style='color:black; text-align:left; width:100%; display:table-row;'><th id='content" + element.Item1 +
                                    "' style='word-break: break-word; width:100%;'><a href='" + element.Item5 + "'target='_blank'>" + element.Item5 + "</a><br><img width='200px' src='" + element.Item5 + "'></img> <textarea class='form-control' id='edit" +
                                    element.Item1 + "' style='visibility: hidden; width: 0; height: 0'>" +
                                    element.Item5 + "</textarea></th><th style='display:inline-flex;'><button id='saveEdit" +
                                    element.Item1 + "' onclick='saveEdit(" + element.Item1 + ")' style='visibility: hidden; width: 0;'>@_localizer.GetString("Išsaugoti")</button><button id='editMessage" +
                                    element.Item1 + "' onclick='editMessage(" + element.Item1 + ")'  style='float:right;'>@_localizer.GetString("Redaguoti")</button><button id='deleteMessage" +
                                    element.Item1 + "' onclick='deleteMessage(" + element.Item1 + ")'  style='float:right;'>@_localizer.GetString("Trinti")</button></th></tr>");
                            }
                        }
                        else {
                            $('#discussion').append("<tr style='color:green; text-align:left; width:100%; display:inline-table;'><th><img src='/avatars/" + element.Item3 + "' style='width:40px;' id='profile-pic" +
                                element.Item1 + "'><strong> " + htmlEncode(element.Item2) +
                                "</strong> " + " " + formatDate(element.Item4) + "</th></tr><tr class='editableMessage' style='color:black; text-align:left; width:100%; display:table-row;'><th id='content" + element.Item1 +
                                "' style='word-break: break-word; width:100%;'>" + htmlEncode(element.Item5) + "<textarea class='form-control' id='edit" +
                                element.Item1 + "' style='visibility: hidden; width: 0; height: 0'>" +
                                element.Item5 + "</textarea></th><th style='display:inline-flex;'><button id='saveEdit" +
                                element.Item1 + "' onclick='saveEdit(" + element.Item1 + ")' style='visibility: hidden; width: 0;'>@_localizer.GetString("Išsaugoti")</button><button id='editMessage" +
                                element.Item1 + "' onclick='editMessage(" + element.Item1 + ")'  style='float:right;'>@_localizer.GetString("Redaguoti")</button><button id='deleteMessage" +
                                element.Item1 + "' onclick='deleteMessage(" + element.Item1 + ")'  style='float:right;'>@_localizer.GetString("Trinti")</button></th></tr>");
                        }
                    }
                    else {
                        if (element.Item6 > element.Item7) {
                            if (validURL(element.Item5)) {
                                if (!checkURL(element.Item5)) {
                                    $('#discussion').append("<tr style='color:green; text-align:left; width:100%; display:inline-table;'><th><img src='/avatars/" + element.Item3 + "' style='width:40px;' id='profile-pic" +
                                        element.Item1 + "'><strong> " + htmlEncode(element.Item2) +
                                        "</strong>" + " " + formatDate(element.Item4) + "</th></tr><tr class='otherMessage' style='color:black; text-align:left; width:100%; display:table-row;'><th id='content" + element.Item1 +
                                        "' style='word-break: break-word; width:100%;'><a href='" + element.Item5 + "'target='_blank'>" + element.Item5 + "</a></th><th></th></tr>");
                                }
                                else {
                                    $('#discussion').append("<tr style='color:green; text-align:left; width:100%; display:inline-table;'><th><img src='/avatars/" + element.Item3 + "' style='width:40px;' id='profile-pic" +
                                        element.Item1 + "'><strong> " + htmlEncode(element.Item2) +
                                        "</strong>" + " " + formatDate(element.Item4) + "</th></tr><tr class='otherMessage' style='color:black; text-align:left; width:100%; display:table-row;'><th id='content" + element.Item1 +
                                        "' style='word-break: break-word; width:100%;'><a href='" + element.Item5 + "'target='_blank'>" + element.Item5 + "</a><br><img width='200px' src='" + element.Item5 + "'></img></th><th></th></tr>");
                                }
                            }
                            else {
                                $('#discussion').append("<tr style='color:green; text-align:left; width:100%; display:inline-table;'><th><img src='/avatars/" + element.Item3 + "' style='width:40px;' id='profile-pic" +
                                    element.Item1 + "'><strong> " + htmlEncode(element.Item2) +
                                    "</strong>" + " " + formatDate(element.Item4) + "</th></tr><tr class='otherMessage' style='color:black; text-align:left; width:100%; display:table-row;'><th id='content" + element.Item1 +
                                    "' style='word-break: break-word; width:100%;'>" + htmlEncode(element.Item5) + "</th><th></th></tr>");
                            }
                        }
                        else {
                            if (validURL(element.Item5)) {
                                if (!checkURL(element.Item5)) {
                                    $('#discussion').append("<tr style='color:green; text-align:left; width:100%; display:inline-table;'><th><img src='/avatars/" + element.Item3 + "' style='width:40px;' id='profile-pic" +
                                        element.Item1 + "'><strong> " + htmlEncode(element.Item2) +
                                        "</strong> " + " " + formatDate(element.Item4) + "</th></tr><tr class='editableMessage' style='color:black; text-align:left; width:100%; display:table-row;'><th id='content" + element.Item1 +
                                        "' style='word-break: break-word; width:100%;'><a href='" + element.Item5 + "'target='_blank'>" + element.Item5 + "</a></th><th style='display:inline-flex;'><button id='deleteMessage" +
                                        element.Item1 + "' onclick='deleteOtherMessage(" + element.Item1 + ", &quot;" + element.Item2 + "&quot;)'  style='float:right;'>@_localizer.GetString("Trinti")</button></th></tr>");
                                }
                                else {
                                    $('#discussion').append("<tr style='color:green; text-align:left; width:100%; display:inline-table;'><th><img src='/avatars/" + element.Item3 + "' style='width:40px;' id='profile-pic" +
                                        element.Item1 + "'><strong> " + htmlEncode(element.Item2) +
                                        "</strong> " + " " + formatDate(element.Item4) + "</th></tr><tr class='editableMessage' style='color:black; text-align:left; width:100%; display:table-row;'><th id='content" + element.Item1 +
                                        "' style='word-break: break-word; width:100%;'><a href='" + element.Item5 + "'target='_blank'>" + element.Item5 + "</a><br><img width='200px' src='" + element.Item5 + "'></img></th><th style='display:inline-flex;'><button id='deleteMessage" +
                                        element.Item1 + "' onclick='deleteOtherMessage(" + element.Item1 + ", &quot;" + element.Item2 + "&quot;)'  style='float:right;'>@_localizer.GetString("Trinti")</button></th></tr>");
                                }
                            }
                            else {
                                $('#discussion').append("<tr style='color:green; text-align:left; width:100%; display:inline-table;'><th><img src='/avatars/" + element.Item3 + "' style='width:40px;' id='profile-pic" +
                                    element.Item1 + "'><strong> " + htmlEncode(element.Item2) +
                                    "</strong> " + " " + formatDate(element.Item4) + "</th></tr><tr class='editableMessage' style='color:black; text-align:left; width:100%; display:table-row;'><th id='content" + element.Item1 +
                                    "' style='word-break: break-word; width:100%;'>" + htmlEncode(element.Item5) + "</th><th style='display:inline-flex;'><button id='deleteMessage" +
                                    element.Item1 + "' onclick='deleteOtherMessage(" + element.Item1 + ", &quot;" + element.Item2 + "&quot;)'  style='float:right;'>@_localizer.GetString("Trinti")</button></th></tr>");
                            }
                            }
                    }
                    $("#cancelSearch").css("visibility", "visible");
                });
                },
                failure: function (response) {
                    console.log("failure send message!");
                }
            });
        }

        function deleteMessagesCommand(count) {
            $.ajax({
                url: '@Url.Action("DeleteMessagesCommand")',
                    type: "POST",
                    data: { channelId: currentChannel, userName: "@User.Identity.Name", messageCount: count },
                dataType: "json",
                    success: function (response) {
                        console.log("kick user success " + response);
                    /* let users = JSON.parse(response);
                    console.log("success get messages! " + msgs + " response ilgis " + msgs.length);
                    $('#ChannelUsers').empty()
                    msgs.forEach((element) => {

                        $("#ChannelUsers").append("<tr><td>" + element.UserName + "</td> <td class='kickrow' onclick=\"kickUser('" + element.Id +  "')\">        </td></tr>");
                    });*/
                        //connection.invoke('DeleteMessage', id, currentChannel);
                        connection.invoke('DeleteMessagesCommand', currentChannel, count);

                },
                failure: function (response) {
                    console.log("failure getting messages!");
                }

                });
        }

        function formatDate(date) {
            var d = new Date(date),
                month = '' + (d.getMonth() + 1),
                day = '' + d.getDate(),
                year = d.getFullYear(),
                hour = d.getHours(),
                minute = d.getMinutes();


            if (month.length < 2)
                month = '0' + month;
            if (day.length < 2)
                day = '0' + day;

            return [year, month, day].join('-') + " " + hour + ":" + minute;
        }



        function validURL(str) {
            var pattern = new RegExp('^(https?:\\/\\/)?' + // protocol
                '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|' + // domain name
                '((\\d{1,3}\\.){3}\\d{1,3}))' + // OR ip (v4) address
                '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*' + // port and path
                '(\\?[;&a-z\\d%_.~+=-]*)?' + // query string
                '(\\#[-a-z\\d_]*)?$', 'i'); // fragment locator
            return !!pattern.test(str);
        }

        function checkURL(url) {
            return (url.match(/\.(jpeg|jpg|gif|png)$/) != null);
        }


    </script>


    <!--//foreach (var msg in Model)
        {
            <script>
     $('#discussion').append('<p style="color:green; text-align:left; width:500px"><strong>' +
         htmlEncode('msg.Author') + ' :</strong> ' + htmlEncode('msg.Content') + '</p>');
            </script>
        }
        <script>updateScroll();</script>
    }-->
}
